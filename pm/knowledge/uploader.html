<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<script type="text/javascript" src="../js/common.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/app.js"></script>
		<script type="text/javascript">
			var state=null;
			var currentId=null;
			var editHtml=null;
			window.addEventListener('uploadId',function(event){
			  //获得事件参数
			  	currentId = event.detail.id;
			  	state=app.getState();
			  	var backbutton=document.getElementById("backList1");
				backbutton.addEventListener('tap', function(){
					jumpBack();
				}, false);
			});
			var server=app.getRequestUrl()+'/vue/file/upload';
			var files=[];
			// 上传文件
			function upload(){
				if(files.length<=0){
					plus.nativeUI.alert("没有添加上传文件！");
					return;
				}
				mui.toast("开始上传：")
				var wt=plus.nativeUI.showWaiting();
				var task=plus.uploader.createUpload(server,
					{method:"POST"},
					function(t,status){ //上传完成
						if(status==200){
							mui.toast("上传成功："+t.responseText);
							plus.storage.setItem("uploader",t.responseText);
							var w=plus.webview.create("uploader_ret.html","uploader_ret.html",{scrollIndicator:'none',scalable:false});
							w.addEventListener("loaded",function(){
								wt.close();
								w.show("slide-in-right",300);
							},false);
						}else{
							mui.toast("上传失败："+status);
							wt.close();
						}
					}
				);
				task.addData("client","HelloH5+");
				task.addData("uid",getUid());
				for(var i=0;i<files.length;i++){
					var f=files[i];
					task.addFile(f.path,{key:f.name});
				}
				task.start();
			}
			// 拍照添加文件
			function appendByCamera(){
				plus.camera.getCamera().captureImage(function(p){
					appendFile(p);
				});	
			}
			// 从相册添加文件
			function appendByGallery(){
				plus.gallery.pick(function(p){
			        appendFile(p);
			    });
			}
			// 添加文件
			var index=1;
			function appendFile(p){
				var fe=document.getElementById("files");
				var li=document.createElement("li");
				var n=p.substr(p.lastIndexOf('/')+1);
				li.innerText=n;
				fe.appendChild(li);
				files.push({name:"uploadkey"+index,path:p});
				index++;
				empty.style.display="none";
			}
			// 产生一个随机数
			function getUid(){
				return Math.floor(Math.random()*100000000+10000000).toString();
			}
			
			function jumpBack(){
				if(!editHtml){
				    editHtml = plus.webview.getWebviewById('knowledge_edit');
				}
				mui.fire(editHtml,'editId',{
					mode:'uploadBack'
				});
				mui.openWindow({
				    id:'knowledge_edit',
				    
				});
				
			}
			
		</script>
		<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-icon mui-icon-left-nav mui-pull-left" id="backList1"></a>
		    <h1 class="mui-title">文件上传</h1>
		    <div class="nvbt idoc" ></div>
		</header>
		<div id="dcontent" class="dcontent">
			<br/>
			<p class="heading">上传文件列表：</p>
			<ul id="files" style="text-align:left;">
				<p id="empty" style="font-size:12px;color:#C6C6C6;">无上传文件</p>
			</ul>
			<table style="width:100%;">
				<tbody>
					<tr>
						<td style="width:40%"><div class="button button-select" onclick="appendByCamera()">拍照</div></td>
						<td style="width:40%"><div class="button button-select" onclick="appendByGallery()">相册选取</div></td>
					</tr>
				</tbody>
			</table>
			<br/>
			<div class="button" onclick="upload()">上 传</div>
			<br/>
			<!--<ul class="dlist">
				<li class="ditem" onclick="appendByCamera()">拍照添加文件</li>
				<li class="ditem" onclick="appendByGallery()">相册添加文件</li>
			</ul>-->
		</div>
	</body>
	<script type="text/javascript" src="../js/immersed.js" ></script>
</html>